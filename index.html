<!DOCTYPE html>
<html>

<head>
    <style>
    #open{
        display:none;
        width:95vw;
        height:95vh;
        background-color: red;
        border-color: red;
        font-size: 50;
    }
    .wrapper{
        text-align: center;
    }
    .button{
        position: absolute;
        top: 50%;
    }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha256.js"></script>
</head>

<body>
<script>

function saveyThing() {
    var password = document.getElementById("pass");
    localStorage.setItem("password", password.value);
    localStorage.setItem("set", true);
    showButton();
}

function showPasswordForm() {
    document.getElementById("passwordform").style.display="inline";
    document.getElementById("open").style.display="none";
    document.getElementById("return").style.display="none";
    localStorage.setItem("set", false);
}

function showButton() {
    document.getElementById("passwordform").style.display="none";
    document.getElementById("open").style.display="inline";
    document.getElementById("return").style.display="inline";
}

$(document).ready(function(){
    $("#open").click(function()
    {
        $.ajax("http://10.13.37.40", 
            {crossDomain: true, 
                type: "GET", 
                dataType: "json", 
                data: {"key": -1},
                beforeSend: function (request)
                {
                    request.withCredentials = true;
                    request.setRequestHeader("Authorization", "Basic  dG9tY2F0OnRvbWNhdA==");
                },
                error:function(jqXHR, textStatus, errorThrown){
                    console.log("textStatus: " + textStatus);
                    console.log("errorThrown: " + errorThrown);
                },
                success:function(data){
                    console.log("It worked!");
                    console.log(data.key);
                    console.log("the data should be above me");
                    var key_string = data.key.toString();
                    var encrypted = CryptoJS.SHA256(key_string + localStorage.getItem("password"));
                    console.log(encrypted.toString(CryptoJS.enc.Hex));
                    // var encrypted = CryptoJS.SHA256(data.key);
                    $.ajax("http://10.13.37.40", 
                        {crossDomain: true, 
                            type: "GET", 
                            dataType: "json", 
                            data: {"key": encrypted.toString(CryptoJS.enc.Hex)},
                            beforeSend: function (request)
                            {
                                request.withCredentials = true;
                                request.setRequestHeader("Authorization", "Basic  dG9tY2F0OnRvbWNhdA==");
                            },
                            error:function(jqXHR, textStatus, errorThrown){
                                console.log("textStatus: " + textStatus);
                                console.log("errorThrown: " + errorThrown);
                            },
                            success:function(data){
                                console.log("Door open:");
                                console.log(data.open);
                            }
                        });
                }
            });
        });
    });

</script>

<form id="passwordform">
Password: <input type="password" name="pwd" id="pass"><br>
<input type="text" style="display:none;">
<input type="button" value="Submit" onclick="saveyThing()">
</form>

<div class="wrapper">
<button id="open">Alohomora!</button>
<button id="return" style="display:none;" onclick="showPasswordForm()">Re-enter password</button>
</div>

<script>
console.log(localStorage.getItem("set"));
if(localStorage.getItem("set") != "null" && localStorage.getItem("set") != "false")
{
    showButton();
}
else
{
    showPasswordForm();
}
</script>
</body>
</html>